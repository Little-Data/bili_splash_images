name: App 启动图

on:
  schedule:
    # 每天UTC时间2点执行，对应中国标准时间(UTC+8)10点
    - cron: '0 2 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  run-script:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp orjson  # 安装脚本所需依赖
      
      - name: 执行程序
        run: python get_app_splash.py
      
      - name: 创建today文件夹（如果不存在）
        run: mkdir -p today
      
      - name: 随机选择当天图片并复制到today文件夹
        id: copy-today-image
        run: |
          # 获取当天日期（格式：YYYYMMDD）
          today_date=$(date +'%Y%m%d')
          
          # 使用Python脚本处理，避免bash数组和空格问题
          python3 << 'EOF'
          import os
          import random
          import glob
          
          # 获取当天日期
          today_date = os.popen('date +%Y%m%d').read().strip()
          
          # 查找当天的所有文件夹
          today_folders = glob.glob(f'app_splash/{today_date}_*')
          
          # 收集所有图片文件，排除hash.txt和image_links.txt
          today_images = []
          for folder in today_folders:
              if os.path.isdir(folder):
                  # 遍历文件夹中的所有文件，排除hash.txt和image_links.txt
                  for file in os.listdir(folder):
                      file_path = os.path.join(folder, file)
                      if os.path.isfile(file_path) and file not in ['hash.txt', 'image_links.txt']:
                          today_images.append(file_path)
          
          # 如果找到图片，随机选择一张
          if today_images:
              selected_image = random.choice(today_images)
              output_path = 'today/today_app_splash.png'
              
              # 复制文件，使用shutil确保跨平台兼容性
              import shutil
              shutil.copy2(selected_image, output_path)
              
              print(f"已从当天图片中随机选择: {selected_image} 复制到 {output_path}")
              print("image_copied=true")
          else:
              print("未找到当天生成的图片文件，跳过复制步骤")
              print("image_copied=false")
          EOF
      
      - name: 配置Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: 检查是否有新的更改
        id: check-changes
        run: |
          if git status --porcelain | grep -q -E "(app_splash/|today/)"; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 提交更改
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git add app_splash/ today/
          git commit -m "自动更新APP启动图 $(date +'%Y-%m-%d')"
          git push
