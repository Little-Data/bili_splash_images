name: 自动获取B站首页图片并提交

on:
  schedule:
    # 每天UTC时间2点执行（对应北京时间10点，UTC+8）
    - cron: '0 2 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  run-getimg:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # 禁用默认凭证，使用GitHub Token
      
      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 python-dateutil
      
      - name: 执行图片获取程序
        run: python getimg.py
      
      - name: 随机选择最新图片到today文件夹
        run: |
          python << 'EOF'
          import os
          import random
          import shutil
          from datetime import datetime
          
          # 获取当天日期（YYYY-MM-DD格式，匹配程序生成的文件夹名）
          today_date = datetime.now().strftime('%Y-%m-%d')
          
          # 源文件夹路径：bili_web_header/YYYY-MM-DD
          source_folder = os.path.join('bili_web_header', today_date)
          
          # 目标文件夹路径和文件名
          target_folder = 'today'
          target_file = os.path.join(target_folder, 'today_web_header.png')
          
          # 创建目标文件夹（如果不存在）
          os.makedirs(target_folder, exist_ok=True)
          
          # 获取当天生成的所有图片文件（排除txt链接信息文件）
          today_images = []
          if os.path.exists(source_folder):
              for filename in os.listdir(source_folder):
                  # 构建完整文件路径
                  file_path = os.path.join(source_folder, filename)
                  # 只选择非txt文件（假设其他都是图片）
                  if not filename.endswith('.txt') and os.path.isfile(file_path):
                      today_images.append(file_path)
          
          # 如果有当天生成的图片
          if today_images:
              # 随机选择一张图片
              selected_image = random.choice(today_images)
              # 复制到目标文件夹，强制使用PNG扩展名
              shutil.copy2(selected_image, target_file)
              print(f"已复制随机图片: {selected_image} -> {target_file}")
          else:
              print(f"当天文件夹 {source_folder} 中没有找到图片，跳过复制步骤")
          EOF
      
      - name: 配置Git用户信息
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: 检查是否有文件变化
        id: check-changes
        run: |
          git status
          echo "has_changes=$(git status --porcelain | grep -q . && echo "true" || echo "false")" >> $GITHUB_OUTPUT
      
      - name: 提交文件到仓库
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # 添加bili_web_header和today文件夹的所有变更
          git add bili_web_header/ today/
          git commit -m "Auto update Bilibili header images $(date +'%Y-%m-%d')"
      
      - name: 推送更改
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
